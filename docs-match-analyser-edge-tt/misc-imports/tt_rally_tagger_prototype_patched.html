<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TT Rally Tagger — Patched</title>
<style>
  :root{
    --bg:#0f1115; --panel:#1b1f2a; --panel-2:#222836; --text:#e6e9ef; --muted:#9aa4b2;
    --accent:#6aa6ff; --accent-2:#7ee787; --danger:#ff6b6b; --warn:#ffd166; --border:#30384a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
  .wrap{display:grid;grid-template-columns:2.1fr 1fr;gap:12px;padding:12px;height:100vh;min-height:600px}
  #courtWrap{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;display:flex;flex-direction:column;min-height:0}
  #court{flex:1;width:100%;border-radius:8px;background:#0b4a86;display:block}
  .toolbar{display:flex;align-items:center;gap:8px;padding:8px 4px 0;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:var(--panel-2);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border)}
  .status{color:var(--muted);font-size:12px}
  #sidePanel{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px;display:flex;flex-direction:column;min-height:0}
  h2{font-size:16px;margin:0 0 8px}
  .section{border-top:1px solid var(--border);margin-top:10px;padding-top:10px}
  .btn-row{display:flex;gap:8px;flex-wrap:wrap}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .rallyRow{display:flex;gap:6px;flex-wrap:wrap}
  .shotChip{border:1px solid var(--border);padding:4px 6px;border-radius:8px;background:transparent;cursor:pointer;white-space:nowrap}
  .small{font-size:12px;color:var(--muted)}
  .foot{margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:8px}
  #diag{white-space:pre-wrap;background:#121722;border:1px solid var(--border);border-radius:8px;padding:8px;margin-top:8px;max-height:120px;overflow:auto}
  @media (max-width: 980px){ .wrap{grid-template-columns:1fr; height:auto} }
</style>
</head>
<body>
<div class="wrap">
  <div id="courtWrap">
    <canvas id="court"></canvas>
    <div class="toolbar">
      <span class="pill" id="phasePill">Phase: —</span>
      <span class="pill" id="playerPill">Player: —</span>
      <span class="pill" id="stickyPill">Sticky: —</span>
      <span class="status" id="hint">Loading…</span>
      <div style="margin-left:auto" class="btn-row">
        <button class="btn" id="btnUndo">Undo</button>
        <button class="btn" id="btnNew">New rally</button>
        <button class="btn" id="btnExport">Export CSV</button>
        <button class="btn" id="btnTest">Test Buttons</button>
      </div>
    </div>
  </div>
  <div id="sidePanel">
    <h2>Controls</h2>
    <div class="grid-2">
      <div>
        <div><strong>Side</strong></div>
        <div class="btn-row" id="sideBtns">
          <button class="btn" data-side="BH">BH (Q)</button>
          <button class="btn" data-side="FH">FH (W)</button>
          <button class="btn" id="clearSide">Clear</button>
        </div>
      </div>
      <div>
        <div><strong>Stroke</strong></div>
        <div class="btn-row" id="strokeBtns">
          <button class="btn" data-stroke="Push">Push (1)</button>
          <button class="btn" data-stroke="Drive">Drive (4)</button>
          <button class="btn" data-stroke="Loop">Loop (5)</button>
          <button class="btn" data-stroke="Block">Block (3)</button>
        </div>
      </div>
      <div>
        <div><strong>Spin</strong></div>
        <div class="btn-row" id="spinBtns">
          <button class="btn" data-spin="None">No (A)</button>
          <button class="btn" data-spin="Top">Top (D)</button>
          <button class="btn" data-spin="Back">Back (F)</button>
        </div>
      </div>
      <div>
        <div><strong>Serve spin</strong></div>
        <div class="btn-row" id="serveSpinBtns">
          <button class="btn" data-sspin="Back">Back (V)</button>
          <button class="btn" data-sspin="Side">Side (B)</button>
          <button class="btn" data-sspin="Top">Top (N)</button>
          <button class="btn" data-sspin="None">No (M)</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div><strong>Outcome</strong></div>
      <div class="btn-row">
        <button class="btn" id="btnWin">Win (;)</button>
        <button class="btn" id="btnFE">Forced (')</button>
        <button class="btn" id="btnUE">Unforced (Enter)</button>
      </div>
    </div>

    <div class="section">
      <div class="rallyRow" id="rallyRow"></div>
      <div class="small" id="serialOut"></div>
    </div>

    <div class="section">
      <strong>Diagnostics</strong>
      <div id="diag">Waiting…</div>
    </div>

    <div class="foot">
      <div class="small">Rallies: <span id="rallyCount">0</span></div>
      <div class="small">© Patched</div>
    </div>
  </div>
</div>

<script>
const diag = (msg)=>{ const el=document.getElementById('diag'); el.textContent += "\\n" + msg; };
window.addEventListener('error',(e)=>{ diag("JS error: " + (e.message||e.error)); });

const canvas = document.getElementById('court');
let ctx=null, DPR=1;

function safeInitCanvas(){
  DPR = Math.max(1, window.devicePixelRatio || 1);
  ctx = canvas.getContext && canvas.getContext('2d');
  if(!ctx){ diag("Canvas 2D context unavailable."); return false; }
  diag("Canvas OK; DPR="+DPR); return true;
}

function resizeCanvas(){
  const wrap = document.getElementById('courtWrap');
  const w = Math.max(300, wrap.clientWidth - 20);
  const hAvail = Math.max(320, (window.innerHeight || document.documentElement.clientHeight) - 180);
  const width = Math.min(w, hAvail * 1.9);
  const height = width/1.9;
  canvas.style.width = width + 'px';
  canvas.style.height = height + 'px';
  canvas.width = Math.round(width * DPR);
  canvas.height = Math.round(height * DPR);
  draw();
}

function draw(){
  if(!ctx) return;
  const w=canvas.width, h=canvas.height;
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle='#0b4a86'; ctx.fillRect(0,0,w,h);
  ctx.strokeStyle='#ffffff'; ctx.lineWidth=2*DPR;
  ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();
  ctx.strokeStyle='rgba(255,255,255,0.5)'; ctx.lineWidth=1*DPR;
  for(let i=1;i<=2;i++){ ctx.beginPath(); ctx.moveTo((w*i)/3,0); ctx.lineTo((w*i)/3,h); ctx.stroke(); }
  for(let i=1;i<=2;i'){ ctx.beginPath(); ctx.moveTo(0,(h*i)/3); ctx.lineTo(w,(h*i)/3); ctx.stroke(); }
  drawMarkers();
}

function toLogical(evt){
  const rect = canvas.getBoundingClientRect();
  const x = (evt.clientX - rect.left) / rect.width;
  const y = (evt.clientY - rect.top) / rect.height;
  return {x:Math.min(1,Math.max(0,x)), y:Math.min(1,Math.max(0,y))};
}

function zoneFrom(x,y){ const depth=y<1/3?'S':y<2/3?'H':'L'; const width=x<1/3?'BH':x<2/3?'M':'FH'; return {depth,width}; }

function drawCircle(px,py,hollow=false){
  if(!ctx) return;
  const r=6*DPR; ctx.beginPath(); ctx.arc(px,py,r,0,Math.PI*2); ctx.lineWidth=2*DPR;
  if(hollow){ ctx.strokeStyle='#fff'; ctx.stroke(); } else { ctx.fillStyle='#fff'; ctx.fill(); }
}
function drawArrow(x1,y1,x2,y2){
  if(!ctx) return;
  ctx.strokeStyle='#fff'; ctx.lineWidth=2*DPR; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
  const ang=Math.atan2(y2-y1,x2-x1), size=8*DPR;
  ctx.beginPath(); ctx.moveTo(x2,y2);
  ctx.lineTo(x2-size*Math.cos(ang-Math.PI/6), y2-size*Math.sin(ang-Math.PI/6));
  ctx.lineTo(x2-size*Math.cos(ang+Math.PI/6), y2-size*Math.sin(ang+Math.PI/6));
  ctx.closePath(); ctx.fillStyle='#fff'; ctx.fill();
}

// Data model
let rallies=[], current=null, stickySide=null, stickyStroke=null, stickySpin=null, serveSpin='Back', phase='serve1', player='A';
function newRally(){ return {id:'R'+Date.now()+'-'+Math.floor(Math.random()*1000), shots:[], outcome:null}; }
function addShot(s){ current.shots.push(s); updateUI(); draw(); }
function undoShot(){ if(current.shots.length){ current.shots.pop(); current.outcome=null; updateUI(); draw(); } }
function finishRally(type){ current.outcome=type; rallies.push(current); current=newRally(); phase='serve1'; player='A'; updateUI(); draw(); }
function togglePlayer(){ player=(player==='A')?'B':'A'; document.getElementById('playerPill').textContent='Player: '+player; }
function phaseText(){ return {serve1:'Serve (bounce)', serve2:'Serve (landing)', rally:'Rally'}[phase]; }
function hintText(){ return phase==='serve1'?'Click server bounce…': phase==='serve2'?'Click serve landing…':'Click landing for next shot…'; }
function drawMarkers(){ const w=canvas.width,h=canvas.height; for(const s of current.shots){ const x1=s.origin.x*w,y1=s.origin.y*h,x2=s.landing.x*w,y2=s.landing.y*h; drawArrow(x1,y1,x2,y2); drawCircle(x1,y1,true); drawCircle(x2,y2,false); } }
function shorthandFor(shot){ const side=shot.side||'?', stroke=(shot.stroke||'').slice(0,2).toUpperCase(); const to=`${shot.zone_to.depth}-${shot.zone_to.width}`; if(shot.type==='Serve'){ return `SV(${shot.spin||'—'}):${shot.zone_from.depth}-${shot.zone_from.width}→${to}`; } return `${side}-${stroke}→${to}`; }

canvas.addEventListener('click',(evt)=>{
  const p=toLogical(evt);
  if(phase==='serve1'){ current._serveBounce=p; phase='serve2'; }
  else if(phase==='serve2'){
    const origin=current._serveBounce, land=p;
    const shot={ idx:current.shots.length, player, type:'Serve', side:stickySide, stroke:'Serve', spin:serveSpin,
      origin, landing:land, zone_from:zoneFrom(origin.x,origin.y), zone_to:zoneFrom(land.x,land.y) };
    shot.shorthand=shorthandFor(shot); addShot(shot); phase='rally'; togglePlayer();
  } else {
    const prev=current.shots[current.shots.length-1]; const origin=prev?prev.landing:{x:.5,y:.15}, land=p;
    const shot={ idx:current.shots.length, player, type:'Stroke', side:stickySide, stroke:stickyStroke, spin:stickySpin,
      origin, landing:land, zone_from:zoneFrom(origin.x,origin.y), zone_to:zoneFrom(land.x,land.y) };
    shot.shorthand=shorthandFor(shot); addShot(shot); togglePlayer();
  }
  updateUI(); draw();
});

function updateUI(){
  document.getElementById('phasePill').textContent='Phase: '+phaseText();
  document.getElementById('hint').textContent=hintText();
  document.getElementById('stickyPill').textContent='Sticky: '+[(stickySide||'—'),(stickyStroke||'—'),(stickySpin||'—')].join(' / ');
  const row=document.getElementById('rallyRow'); row.innerHTML='';
  current.shots.forEach((s,i)=>{ const b=document.createElement('button'); b.className='shotChip'; b.textContent=`${i+1}:${s.shorthand}`; b.onclick=()=>{ const order=[null,'Push','Drive','Loop','Block']; const ix=order.indexOf(s.stroke); s.stroke=order[(ix+1)%order.length]; s.shorthand=shorthandFor(s); updateUI(); draw(); }; row.appendChild(b); });
  document.getElementById('serialOut').textContent=current.shots.map(s=>s.shorthand).join(' , ')+(current.outcome?` [${current.outcome}]`:'');
  document.getElementById('rallyCount').textContent=String(rallies.length);
}

// Buttons & keys
function byId(id){ return document.getElementById(id); }
byId('btnTest').onclick=()=>{ diag("Buttons responsive ✅"); alert("Buttons responsive ✅"); };
byId('btnUndo').onclick=()=>{ undoShot(); if(!current.shots.length) phase='serve1'; updateUI(); };
byId('btnNew').onclick=()=>{ rallies.push(current); current=newRally(); phase='serve1'; player='A'; updateUI(); draw(); };
byId('btnExport').onclick=exportCSV;
byId('btnWin').onclick=()=>finishRally('Win');
byId('btnFE').onclick=()=>finishRally('Forced');
byId('btnUE').onclick=()=>finishRally('Unforced');
byId('sideBtns').addEventListener('click',(e)=>{ const b=e.target.closest('button[data-side]'); if(!b) return; stickySide=b.dataset.side; updateUI(); });
byId('clearSide').onclick=()=>{ stickySide=null; updateUI(); };
byId('strokeBtns').addEventListener('click',(e)=>{ const b=e.target.closest('button[data-stroke]'); if(!b) return; stickyStroke=b.dataset.stroke; updateUI(); });
byId('spinBtns').addEventListener('click',(e)=>{ const b=e.target.closest('button[data-spin]'); if(!b) return; stickySpin=b.dataset.spin; updateUI(); });
byId('serveSpinBtns').addEventListener('click',(e)=>{ const b=e.target.closest('button[data-sspin]'); if(!b) return; serveSpin=b.dataset.sspin; updateUI(); });

window.addEventListener('keydown',(e)=>{
  const k=e.key.toLowerCase();
  if(e.key==='Backspace'){ e.preventDefault(); undoShot(); if(!current.shots.length) phase='serve1'; updateUI(); return; }
  if(k==='q'){ stickySide='BH'; updateUI(); return; }
  if(k==='w'){ stickySide='FH'; updateUI(); return; }
  const strokeMap={'1':'Push','3':'Block','4':'Drive','5':'Loop'}; if(strokeMap[e.key]){ stickyStroke=strokeMap[e.key]; updateUI(); return; }
  const spinMap={a:'None', d:'Top', f:'Back'}; if(spinMap[k]){ stickySpin=spinMap[k]; updateUI(); return; }
  const sspinMap={v:'Back', b:'Side', n:'Top', m:'None'}; if(sspinMap[k]){ serveSpin=sspinMap[k]; updateUI(); return; }
  if(e.key===';'){ finishRally('Win'); return; }
  if(e.key=="'"){ finishRally('Forced'); return; }
  if(e.key==='Enter'){ finishRally('Unforced'); return; }
  if(k==='n'){ rallies.push(current); current=newRally(); phase='serve1'; player='A'; updateUI(); draw(); return; }
});

function csvEscape(v){ if(v==null) return ''; const s=String(v); return /[",\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"': s; }
function exportCSV(){
  const rows=[], header=['rally_id','shot_idx','player','type','side','stroke','spin','serve_spin','origin_x','origin_y','land_x','land_y','from_depth','from_width','to_depth','to_width','shorthand','outcome']; rows.push(header.join(','));
  for(const r of [...rallies, current]){
    for(const s of r.shots){
      rows.push([r.id,s.idx,s.player,s.type,s.side||'',s.stroke||'',(s.spin||''),(s.type==='Serve'? serveSpin:''),
        s.origin.x.toFixed(4),s.origin.y.toFixed(4),s.landing.x.toFixed(4),s.landing.y.toFixed(4),
        s.zone_from.depth,s.zone_from.width,s.zone_to.depth,s.zone_to.width,s.shorthand,r.outcome||''].map(csvEscape).join(','));
    }
  }
  const blob=new Blob([rows.join('\\n')],{type:'text/csv'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='tt_rallies.csv'; a.click(); URL.revokeObjectURL(url);
}

function start(){
  diag("Starting…");
  if(!safeInitCanvas()){ diag("Canvas init failed."); return; }
  current=newRally(); phase='serve1'; player='A';
  resizeCanvas(); updateUI();
  diag("Initialized ✅ Click: bounce → landing");
}
window.addEventListener('load', start);
window.addEventListener('resize', ()=>{ if(ctx) resizeCanvas(); });
</script>
</body>
</html>
