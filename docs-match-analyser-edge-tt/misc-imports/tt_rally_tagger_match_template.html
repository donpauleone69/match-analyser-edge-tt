<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TT Rally Tagger — Match Template Formatter</title>
<style>
  :root{ --bg:#0f1115; --panel:#1b1f2a; --panel-2:#222836; --text:#e6e9ef; --muted:#9aa4b2; --border:#30384a; --accent:#6aa6ff }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{display:grid;grid-template-columns:2fr 1fr;gap:12px;padding:12px;height:100vh;min-height:560px}
  #courtWrap{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;display:flex;flex-direction:column;min-height:0}
  #court{flex:1;width:100%;border-radius:8px;background:#0b4a86;display:block}
  .toolbar{display:flex;align-items:center;gap:8px;padding:8px 4px 0;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:var(--panel-2);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}
  .btn.small{padding:6px 8px;font-size:12px}
  .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border)}
  #sidePanel{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px;display:flex;flex-direction:column;min-height:0}
  h2{font-size:16px;margin:0 0 8px}
  .section{border-top:1px solid var(--border);margin-top:10px;padding-top:10px}
  .btn-row{display:flex;gap:8px;flex-wrap:wrap}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .rallyRow{display:flex;gap:6px;flex-wrap:wrap}
  .shotChip{border:1px solid var(--border);padding:4px 6px;border-radius:8px;background:transparent;cursor:pointer;white-space:nowrap}
  .small{font-size:12px;color:var(--muted)}
  .foot{margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:8px}
  #diag{white-space:pre-wrap;background:#121722;border:1px solid var(--border);border-radius:8px;padding:8px;margin-top:8px;max-height:120px;overflow:auto}
  #shotList{list-style:decimal;padding-left:18px;margin:6px 0;max-height:140px;overflow:auto}
  #historyList{display:flex;flex-direction:column;gap:6px;max-height:160px;overflow:auto}
  .historyItem{border:1px solid var(--border);border-radius:8px;padding:6px 8px;background:var(--panel-2)}
  .historyTop{display:flex;justify-content:space-between;gap:8px}
  .muted{color:var(--muted)}
  details.settings{border:1px solid var(--border);border-radius:10px;padding:8px;background:var(--panel-2)}
  details.settings summary{cursor:pointer}
  .field{display:flex;gap:8px;align-items:center;margin:6px 0}
  .field label{width:170px;color:var(--muted)}
  input[type="text"]{width:100%;background:#0f131d;border:1px solid var(--border);border-radius:8px;color:var(--text);padding:6px 8px}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  @media (max-width: 980px){ .wrap{grid-template-columns:1fr; height:auto} }
</style>
</head>
<body>
<div class="wrap">
  <div id="courtWrap">
    <canvas id="court"></canvas>
    <div class="toolbar">
      <span class="pill small" id="phasePill">Phase: —</span>
      <span class="pill small" id="playerPill">Player: —</span>
      <span class="pill small" id="stickyPill">Sticky: —</span>
      <button class="btn small" id="btnStart">Start</button>
      <div style="margin-left:auto" class="btn-row">
        <button class="btn small" id="btnUndo">Undo</button>
        <button class="btn small" id="btnNew">New rally</button>
        <button class="btn small" id="btnExport">Export CSV</button>
      </div>
    </div>
  </div>
  <div id="sidePanel">
    <h2>Controls</h2>
    <div class="grid-2">
      <div>
        <div><strong>Side</strong></div>
        <div class="btn-row" id="sideBtns">
          <button class="btn" data-side="BH">BH</button>
          <button class="btn" data-side="FH">FH</button>
          <button class="btn" id="clearSide">Clear</button>
        </div>
      </div>
      <div>
        <div><strong>Stroke</strong></div>
        <div class="btn-row" id="strokeBtns">
          <button class="btn" data-stroke="Push">Push</button>
          <button class="btn" data-stroke="Drive">Drive</button>
          <button class="btn" data-stroke="Loop">Loop</button>
          <button class="btn" data-stroke="Block">Block</button>
          <button class="btn" data-stroke="Chop">Chop</button>
          <button class="btn" data-stroke="Flick">Flick</button>
          <button class="btn" data-stroke="Counter">Counter</button>
          <button class="btn" data-stroke="Smash">Smash</button>
        </div>
      </div>
      <div>
        <div><strong>Spin</strong></div>
        <div class="btn-row" id="spinBtns">
          <button class="btn" data-spin="None">No</button>
          <button class="btn" data-spin="Top">Top</button>
          <button class="btn" data-spin="Back">Back</button>
          <button class="btn" data-spin="Side">Side</button>
          <button class="btn" data-spin="Kick">Kick</button>
        </div>
      </div>
      <div>
        <div><strong>Serve spin</strong></div>
        <div class="btn-row" id="serveSpinBtns">
          <button class="btn" data-sspin="Back">Back</button>
          <button class="btn" data-sspin="Side">Side</button>
          <button class="btn" data-sspin="Top">Top</button>
          <button class="btn" data-sspin="None">No</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
        <strong>Current Rally — shorthand</strong>
        <div class="btn-row">
          <button class="btn small" id="btnCopyCur">Copy</button>
        </div>
      </div>
      <ol id="shotList"></ol>
      <div class="small"><span class="muted">Full:</span> <span id="serialOut"></span></div>
    </div>

    <div class="section">
      <div style="display:flex;align-items:center;gap:8px;justify-content:space-between">
        <strong>Rallies history</strong>
        <button class="btn small" id="btnCopyAll">Copy all</button>
      </div>
      <div id="historyList"></div>
    </div>

    <div class="section">
      <details class="settings">
        <summary><strong>Match analysis template settings</strong> — tweak abbreviations & format</summary>
        <div class="two">
          <div>
            <div class="field"><label>FH abbrev</label><input id="abbrFH" type="text" value="FH"></div>
            <div class="field"><label>BH abbrev</label><input id="abbrBH" type="text" value="BH"></div>
            <div class="field"><label>Depth: Short</label><input id="abbrS" type="text" value="S"></div>
            <div class="field"><label>Depth: Half</label><input id="abbrH" type="text" value="H"></div>
            <div class="field"><label>Depth: Long</label><input id="abbrL" type="text" value="L"></div>
          </div>
          <div>
            <div class="field"><label>Spin: Back</label><input id="abbrBack" type="text" value="B"></div>
            <div class="field"><label>Spin: Top</label><input id="abbrTop" type="text" value="T"></div>
            <div class="field"><label>Spin: Side</label><input id="abbrSide" type="text" value="S"></div>
            <div class="field"><label>Spin: None</label><input id="abbrNone" type="text" value="N"></div>
          </div>
        </div>
        <div class="two">
          <div>
            <div class="field"><label>Push</label><input id="abbrPush" type="text" value="P"></div>
            <div class="field"><label>Drive</label><input id="abbrDrive" type="text" value="DR"></div>
            <div class="field"><label>Loop</label><input id="abbrLoop" type="text" value="LO"></div>
            <div class="field"><label>Block</label><input id="abbrBlock" type="text" value="BL"></div>
            <div class="field"><label>Chop</label><input id="abbrChop" type="text" value="CH"></div>
            <div class="field"><label>Flick</label><input id="abbrFlick" type="text" value="FL"></div>
            <div class="field"><label>Counter</label><input id="abbrCounter" type="text" value="CT"></div>
            <div class="field"><label>Smash</label><input id="abbrSmash" type="text" value="SM"></div>
          </div>
          <div>
            <div class="field"><label>Format (stroke)</label><input id="fmtStroke" type="text" value="{SIDE}-{STROKE}→{COL}-{DEPTH}"></div>
            <div class="field"><label>Format (stroke, detailed)</label><input id="fmtStrokeDet" type="text" value="{SIDE}-{STROKE}→{COL}({DEPTH}-{SPIN}-{COL})"></div>
            <div class="field"><label>Format (serve)</label><input id="fmtServe" type="text" value="{SSPIN}-{START}→{COL}({DEPTH}-{SSPIN}-{COL})"></div>
          </div>
        </div>
        <div class="small muted">Tip: use dash separators exactly how you like; your examples included <code>FH-LO→BH-L</code> and <code>B-BH→M(H-UL-M)</code>. Adjust the fields to match.</div>
      </details>
    </div>

    <div class="section">
      <strong>Diagnostics</strong>
      <div id="diag">Waiting…</div>
    </div>

    <div class="foot">
      <div class="small">Rallies: <span id="rallyCount">0</span></div>
      <div class="small">© Match Template</div>
    </div>
  </div>
</div>

<script defer>
(function(){
  var diagEl;
  function diag(msg){
    try{
      if(!diagEl) diagEl = document.getElementById('diag');
      if(diagEl) diagEl.textContent += "\\n" + msg;
      console.log("[TT] " + msg);
    }catch(e){ /* ignore */ }
  }
  function ready(fn){
    if(document.readyState !== 'loading'){ fn(); }
    else document.addEventListener('DOMContentLoaded', fn);
  }

  ready(function(){
    diagEl = document.getElementById('diag');
    diag("DOM ready");

    // Elements
    var canvas = document.getElementById('court');
    var ctx = canvas && canvas.getContext ? canvas.getContext('2d') : null;
    if(!canvas || !ctx){ diag("Canvas context not available"); }

    // Settings getters
    function G(id){ var el=document.getElementById(id); return el? el.value : ""; }
    function strokeAbbrev(name){
      var map = {
        Push: G('abbrPush'), Drive: G('abbrDrive'), Loop: G('abbrLoop'), Block: G('abbrBlock'),
        Chop: G('abbrChop'), Flick: G('abbrFlick'), Counter: G('abbrCounter'), Smash: G('abbrSmash')
      };
      return (map[name] || (name? name[0].toUpperCase(): '?'));
    }
    function sideAbbrev(side){ return side==='FH'? G('abbrFH'): (side==='BH'? G('abbrBH'): '?'); }
    function spinAbbrev(spin){
      if(spin==='Back') return G('abbrBack');
      if(spin==='Top') return G('abbrTop');
      if(spin==='Side') return G('abbrSide');
      if(spin==='None') return G('abbrNone');
      if(spin==='Kick') return 'K';
      return '?';
    }
    function depthAbbrev(depth){ return depth==='S'? G('abbrS'): depth==='H'? G('abbrH'): G('abbrL'); }

    var DPR = Math.max(1, window.devicePixelRatio || 1);
    function resizeCanvas(){
      if(!canvas) return;
      var wrap = document.getElementById('courtWrap');
      var w = Math.max(300, wrap.clientWidth - 20);
      var hAvail = Math.max(320, (window.innerHeight || document.documentElement.clientHeight) - 180);
      var width = Math.min(w, hAvail * 1.9);
      var height = width/1.9;
      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';
      canvas.width = Math.round(width * DPR);
      canvas.height = Math.round(height * DPR);
      draw();
    }
    function draw(){
      if(!ctx) return;
      var w=canvas.width, h=canvas.height;
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle='#0b4a86'; ctx.fillRect(0,0,w,h);
      ctx.strokeStyle='#ffffff'; ctx.lineWidth=2*DPR;
      ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();
      ctx.strokeStyle='rgba(255,255,255,0.5)'; ctx.lineWidth=1*DPR;
      for(var i=1;i<=2;i++){ ctx.beginPath(); ctx.moveTo((w*i)/3,0); ctx.lineTo((w*i)/3,h); ctx.stroke(); }
      for(var j=1;j<=2;j++){ ctx.beginPath(); ctx.moveTo(0,(h*j)/3); ctx.lineTo(w,(h*j)/3); ctx.stroke(); }
      drawMarkers();
    }
    function toLogical(evt){
      var rect = canvas.getBoundingClientRect();
      var x = (evt.clientX - rect.left) / rect.width;
      var y = (evt.clientY - rect.top) / rect.height;
      return {x:Math.min(1,Math.max(0,x)), y:Math.min(1,Math.max(0,y))};
    }
    function zoneFrom(x,y){ var depth=y<1/3?'S':y<2/3?'H':'L'; var width=x<1/3?'BH':x<2/3?'M':'FH'; return {depth:depth,width:width}; }
    function drawCircle(px,py,hollow){
      if(!ctx) return;
      var r=6*DPR; ctx.beginPath(); ctx.arc(px,py,r,0,Math.PI*2); ctx.lineWidth=2*DPR;
      if(hollow){ ctx.strokeStyle='#fff'; ctx.stroke(); } else { ctx.fillStyle='#fff'; ctx.fill(); }
    }
    function drawArrow(x1,y1,x2,y2){
      if(!ctx) return;
      ctx.strokeStyle='#fff'; ctx.lineWidth=2*DPR; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
      var ang=Math.atan2(y2-y1,x2-x1), size=8*DPR;
      ctx.beginPath(); ctx.moveTo(x2,y2);
      ctx.lineTo(x2-size*Math.cos(ang-Math.PI/6), y2-size*Math.sin(ang-Math.PI/6));
      ctx.lineTo(x2-size*Math.cos(ang+Math.PI/6), y2-size*Math.sin(ang+Math.PI/6));
      ctx.closePath(); ctx.fillStyle='#fff'; ctx.fill();
    }

    // Data model
    var rallies=[], current=null, stickySide=null, stickyStroke=null, stickySpin=null, serveSpin='Back', phase='serve1', player='A';

    function newRally(){ return {id:'R'+Date.now()+'-'+Math.floor(Math.random()*1000), shots:[], outcome:null}; }
    function addShot(s){ current.shots.push(s); updateUI(); draw(); }
    function undoShot(){ if(current.shots.length){ current.shots.pop(); current.outcome=null; updateUI(); draw(); } }
    function finishRally(type){ current.outcome=type; rallies.push(current); current=newRally(); phase='serve1'; player='A'; updateUI(); draw(); }
    function togglePlayer(){ player=(player==='A')?'B':'A'; var pp=document.getElementById('playerPill'); if(pp) pp.textContent='Player: '+player; }
    function phaseText(){ return {serve1:'Serve (bounce)', serve2:'Serve (landing)', rally:'Rally'}[phase]; }

    function drawMarkers(){
      var w=canvas.width,h=canvas.height;
      for(var k=0;k<current.shots.length;k++){
        var s=current.shots[k];
        var x1=s.origin.x*w,y1=s.origin.y*h,x2=s.landing.x*w,y2=s.landing.y*h;
        drawArrow(x1,y1,x2,y2); drawCircle(x1,y1,true); drawCircle(x2,y2,false);
      }
    }

    // ======= Formatting according to template =======
    var useDetailed = true; // choose detailed by default

    function formatStroke(shot){
      var SIDE = sideAbbrev(shot.side||'?');
      var STROKE = strokeAbbrev(shot.stroke||'');
      var COL = shot.zone_to.width; // BH/M/FH
      var DEPTH = depthAbbrev(shot.zone_to.depth); // S/H/L
      var SPIN = spinAbbrev(shot.spin||'None');
      var fmt = useDetailed ? G('fmtStrokeDet') : G('fmtStroke');
      return fmt.replace(/{SIDE}/g,SIDE).replace(/{STROKE}/g,STROKE).replace(/{COL}/g,COL).replace(/{DEPTH}/g,DEPTH).replace(/{SPIN}/g,SPIN);
    }

    function formatServe(shot){
      // Per your rule: remove S-; use serve spin abbrev + dash + start location
      var START = shot.zone_from.width; // BH/M/FH
      var COL = shot.zone_to.width;
      var DEPTH = depthAbbrev(shot.zone_to.depth);
      var SSPIN = spinAbbrev(shot.spin||'None');
      var fmt = G('fmtServe');
      return fmt.replace(/{SSPIN}/g,SSPIN).replace(/{START}/g,START).replace(/{COL}/g,COL).replace(/{DEPTH}/g,DEPTH);
    }

    function shorthandFor(shot){
      if(shot.type==='Serve') return formatServe(shot);
      return formatStroke(shot);
    }
    function rallyString(r){
      var t='';
      for(var j=0;j<r.shots.length;j++){ t += (j? ' , ':'') + shorthandFor(r.shots[j]); }
      if(r.outcome) t += ' ['+r.outcome+']';
      return t;
    }

    function updateHistory(){
      var list = document.getElementById('historyList'); if(!list) return;
      list.innerHTML='';
      for(var i=0;i<rallies.length;i++){
        var r = rallies[i];
        var item = document.createElement('div'); item.className='historyItem';
        var top = document.createElement('div'); top.className='historyTop';
        var left = document.createElement('div'); left.innerHTML = '<span class="muted">'+r.id+'</span>';
        var right = document.createElement('div'); right.innerHTML = '<span class="muted">'+r.shots.length+' shots</span>';
        top.appendChild(left); top.appendChild(right);
        var body = document.createElement('div'); body.textContent = rallyString(r);
        item.appendChild(top); item.appendChild(body);
        list.appendChild(item);
      }
    }

    function updateUI(){
      var ph=document.getElementById('phasePill'); if(ph) ph.textContent='Phase: '+phaseText();
      var st=document.getElementById('stickyPill'); if(st) st.textContent='Sticky: '+[(stickySide||'—'),(stickyStroke||'—'),(stickySpin||'—')].join(' / ');
      // Per-shot list
      var ol=document.getElementById('shotList'); if(ol){ ol.innerHTML=''; for(var i=0;i<current.shots.length;i++){ var li=document.createElement('li'); li.textContent = shorthandFor(current.shots[i]); ol.appendChild(li); } }
      // Full string
      var so=document.getElementById('serialOut'); if(so){ so.textContent = rallyString(current); }
      // Count
      var rc=document.getElementById('rallyCount'); if(rc) rc.textContent=String(rallies.length);
      // History
      updateHistory();
    }

    function exportCSV(){
      var rows=[], header=['rally_id','shot_idx','player','type','side','stroke','spin','serve_spin','origin_x','origin_y','land_x','land_y','from_depth','from_width','to_depth','to_width','shorthand','outcome']; rows.push(header.join(','));
      for(var rIndex=0; rIndex<rallies.length+1; rIndex++){
        var r = (rIndex<rallies.length) ? rallies[rIndex] : current;
        if(!r) continue;
        for(var sIndex=0; sIndex<r.shots.length; sIndex++){
          var s = r.shots[sIndex];
          var sh = shorthandFor(s);
          rows.push([r.id,s.idx,s.player,s.type,s.side||'',s.stroke||'',(s.spin||''),(s.type==='Serve'? s.spin:''),
            s.origin.x.toFixed(4),s.origin.y.toFixed(4),s.landing.x.toFixed(4),s.landing.y.toFixed(4),
            s.zone_from.depth,s.zone_from.width,s.zone_to.depth,s.zone_to.width,sh,r.outcome||''].join(','));
        }
      }
      var blob=new Blob([rows.join('\\n')],{type:'text/csv'});
      var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='tt_rallies.csv'; a.click(); URL.revokeObjectURL(url);
    }

    // Wiring
    function wireUI(){
      var cStart = document.getElementById('btnStart'); if(cStart){ cStart.onclick = init; }
      var bUndo=document.getElementById('btnUndo'); if(bUndo) bUndo.onclick=function(){ undoShot(); if(!current.shots.length) phase='serve1'; updateUI(); };
      var bNew=document.getElementById('btnNew'); if(bNew) bNew.onclick=function(){ rallies.push(current); current=newRally(); phase='serve1'; player='A'; updateUI(); draw(); };
      var bExp=document.getElementById('btnExport'); if(bExp) bExp.onclick=exportCSV;
      var sideBtns=document.getElementById('sideBtns');
      if(sideBtns){ sideBtns.addEventListener('click', function(e){ var b=e.target.closest('button[data-side]'); if(!b) return; stickySide=b.getAttribute('data-side'); updateUI(); }); }
      var clearSide=document.getElementById('clearSide'); if(clearSide){ clearSide.onclick=function(){ stickySide=null; updateUI(); }; }
      var strokeBtns=document.getElementById('strokeBtns');
      if(strokeBtns){ strokeBtns.addEventListener('click', function(e){ var b=e.target.closest('button[data-stroke]'); if(!b) return; stickyStroke=b.getAttribute('data-stroke'); updateUI(); }); }
      var spinBtns=document.getElementById('spinBtns');
      if(spinBtns){ spinBtns.addEventListener('click', function(e){ var b=e.target.closest('button[data-spin]'); if(!b) return; stickySpin=b.getAttribute('data-spin'); updateUI(); }); }
      var sspinBtns=document.getElementById('serveSpinBtns');
      if(sspinBtns){ sspinBtns.addEventListener('click', function(e){ var b=e.target.closest('button[data-sspin]'); if(!b) return; serveSpin=b.getAttribute('data-sspin'); updateUI(); }); }

      var copyCur=document.getElementById('btnCopyCur'); if(copyCur){ copyCur.onclick=function(){ var s=document.getElementById('serialOut').textContent||''; navigator.clipboard && navigator.clipboard.writeText(s); }; }
      var copyAll=document.getElementById('btnCopyAll'); if(copyAll){ copyAll.onclick=function(){ var all = rallies.map(rallyString).join('\\n'); navigator.clipboard && navigator.clipboard.writeText(all); }; }

      // React to format changes immediately
      document.querySelectorAll('input').forEach(function(inp){ inp.addEventListener('input', updateUI); });
    }

    function init(){
      if(!current){ current=newRally(); }
      phase='serve1'; player='A';
      resizeCanvas(); updateUI();
      if(canvas){
        canvas.addEventListener('click', function(evt){
          var p=toLogical(evt);
          if(phase==='serve1'){ current._serveBounce=p; phase='serve2'; updateUI(); draw(); return; }
          if(phase==='serve2'){
            var origin=current._serveBounce, land=p;
            var shot={ idx:current.shots.length, player:player, type:'Serve', side:stickySide, stroke:'Serve', spin:serveSpin,
              origin:origin, landing:land, zone_from:zoneFrom(origin.x,origin.y), zone_to:zoneFrom(land.x,land.y) };
            addShot(shot); phase='rally'; togglePlayer(); return;
          }
          var prev=current.shots[current.shots.length-1];
          var origin2 = prev ? prev.landing : {x:.5,y:.15};
          var land2 = p;
          var shot2={ idx:current.shots.length, player:player, type:'Stroke', side:stickySide, stroke:stickyStroke, spin:stickySpin,
            origin:origin2, landing:land2, zone_from:zoneFrom(origin2.x,origin2.y), zone_to:zoneFrom(land2.x,land2.y) };
          addShot(shot2); togglePlayer();
        });
      }
      diag("Initialized");
    }

    // Start
    wireUI();
    init();
    window.addEventListener('resize', resizeCanvas);
  });
})();
</script>
</body>
</html>
