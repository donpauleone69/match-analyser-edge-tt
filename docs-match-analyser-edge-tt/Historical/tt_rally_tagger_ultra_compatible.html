<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>TT Rally Tagger — Ultra-Compatible</title>
<style>
  :root{ --bg:#0f1115; --panel:#1b1f2a; --panel-2:#222836; --text:#e6e9ef; --muted:#9aa4b2; --border:#30384a }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu}
  .wrap{display:grid;grid-template-columns:2fr 1fr;gap:12px;padding:12px;height:100vh;min-height:560px}
  #courtWrap{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;display:flex;flex-direction:column;min-height:0}
  #court{flex:1;width:100%;border-radius:8px;background:#0b4a86;display:block}
  .toolbar{display:flex;align-items:center;gap:8px;padding:8px 4px 0;flex-wrap:wrap}
  .btn{border:1px solid var(--border);background:var(--panel-2);color:var(--text);padding:8px 10px;border-radius:8px;cursor:pointer}
  #sidePanel{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px;display:flex;flex-direction:column;min-height:0}
  h2{font-size:16px;margin:0 0 8px}
  .section{border-top:1px solid var(--border);margin-top:10px;padding-top:10px}
  .btn-row{display:flex;gap:8px;flex-wrap:wrap}
  .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .rallyRow{display:flex;gap:6px;flex-wrap:wrap}
  .shotChip{border:1px solid var(--border);padding:4px 6px;border-radius:8px;background:transparent;cursor:pointer;white-space:nowrap}
  .small{font-size:12px;color:var(--muted)}
  .foot{margin-top:auto;display:flex;justify-content:space-between;align-items:center;gap:8px}
  #diag{white-space:pre-wrap;background:#121722;border:1px solid var(--border);border-radius:8px;padding:8px;margin-top:8px;max-height:120px;overflow:auto}
  @media (max-width: 980px){ .wrap{grid-template-columns:1fr; height:auto} }
</style>
</head>
<body>
<div class="wrap">
  <div id="courtWrap">
    <canvas id="court"></canvas>
    <div class="toolbar">
      <span class="small" id="phasePill">Phase: —</span>
      <span class="small" id="playerPill">Player: —</span>
      <span class="small" id="stickyPill">Sticky: —</span>
      <button class="btn" id="btnStart">Start (fallback)</button>
      <div style="margin-left:auto" class="btn-row">
        <button class="btn" id="btnUndo">Undo</button>
        <button class="btn" id="btnNew">New rally</button>
        <button class="btn" id="btnExport">Export CSV</button>
      </div>
    </div>
  </div>
  <div id="sidePanel">
    <h2>Controls</h2>
    <div class="grid-2">
      <div>
        <div><strong>Side</strong></div>
        <div class="btn-row" id="sideBtns">
          <button class="btn" data-side="BH">BH</button>
          <button class="btn" data-side="FH">FH</button>
          <button class="btn" id="clearSide">Clear</button>
        </div>
      </div>
      <div>
        <div><strong>Stroke</strong></div>
        <div class="btn-row" id="strokeBtns">
          <button class="btn" data-stroke="Push">Push</button>
          <button class="btn" data-stroke="Drive">Drive</button>
          <button class="btn" data-stroke="Loop">Loop</button>
          <button class="btn" data-stroke="Block">Block</button>
        </div>
      </div>
      <div>
        <div><strong>Spin</strong></div>
        <div class="btn-row" id="spinBtns">
          <button class="btn" data-spin="None">No</button>
          <button class="btn" data-spin="Top">Top</button>
          <button class="btn" data-spin="Back">Back</button>
        </div>
      </div>
      <div>
        <div><strong>Serve spin</strong></div>
        <div class="btn-row" id="serveSpinBtns">
          <button class="btn" data-sspin="Back">Back</button>
          <button class="btn" data-sspin="Side">Side</button>
          <button class="btn" data-sspin="Top">Top</button>
          <button class="btn" data-sspin="None">No</button>
        </div>
      </div>
    </div>

    <div class="section">
      <div><strong>Outcome</strong></div>
      <div class="btn-row">
        <button class="btn" id="btnWin">Win</button>
        <button class="btn" id="btnFE">Forced</button>
        <button class="btn" id="btnUE">Unforced</button>
      </div>
    </div>

    <div class="section">
      <div class="rallyRow" id="rallyRow"></div>
      <div class="small" id="serialOut"></div>
    </div>

    <div class="section">
      <strong>Diagnostics</strong>
      <div id="diag">Waiting…</div>
    </div>

    <div class="foot">
      <div class="small">Rallies: <span id="rallyCount">0</span></div>
      <div class="small">© Ultra-Compatible</div>
    </div>
  </div>
</div>

<script defer>
(function(){
  var diagEl;
  function diag(msg){
    try{
      if(!diagEl) diagEl = document.getElementById('diag');
      if(diagEl) diagEl.textContent += "\\n" + msg;
      console.log("[TT] " + msg);
    }catch(e){ /* ignore */ }
  }

  // Guards for DOM ready
  function ready(fn){
    if(document.readyState !== 'loading'){ fn(); }
    else document.addEventListener('DOMContentLoaded', fn);
  }

  ready(function(){
    diagEl = document.getElementById('diag');
    diag("DOM ready");

    // Elements
    var canvas = document.getElementById('court');
    var ctx = canvas && canvas.getContext ? canvas.getContext('2d') : null;
    if(!canvas || !ctx){ diag("Canvas context not available"); }

    var DPR = Math.max(1, window.devicePixelRatio || 1);

    function resizeCanvas(){
      if(!canvas) return;
      var wrap = document.getElementById('courtWrap');
      var w = Math.max(300, wrap.clientWidth - 20);
      var hAvail = Math.max(320, (window.innerHeight || document.documentElement.clientHeight) - 180);
      var width = Math.min(w, hAvail * 1.9);
      var height = width/1.9;
      canvas.style.width = width + 'px';
      canvas.style.height = height + 'px';
      canvas.width = Math.round(width * DPR);
      canvas.height = Math.round(height * DPR);
      draw();
    }

    function draw(){
      if(!ctx) return;
      var w=canvas.width, h=canvas.height;
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle='#0b4a86'; ctx.fillRect(0,0,w,h);
      ctx.strokeStyle='#ffffff'; ctx.lineWidth=2*DPR;
      ctx.beginPath(); ctx.moveTo(0,h/2); ctx.lineTo(w,h/2); ctx.stroke();
      ctx.strokeStyle='rgba(255,255,255,0.5)'; ctx.lineWidth=1*DPR;
      for(var i=1;i<=2;i++){ ctx.beginPath(); ctx.moveTo((w*i)/3,0); ctx.lineTo((w*i)/3,h); ctx.stroke(); }
      for(var j=1;j<=2;j++){ ctx.beginPath(); ctx.moveTo(0,(h*j)/3); ctx.lineTo(w,(h*j)/3); ctx.stroke(); }
      drawMarkers();
    }

    function toLogical(evt){
      var rect = canvas.getBoundingClientRect();
      var x = (evt.clientX - rect.left) / rect.width;
      var y = (evt.clientY - rect.top) / rect.height;
      return {x:Math.min(1,Math.max(0,x)), y:Math.min(1,Math.max(0,y))};
    }

    function zoneFrom(x,y){ var depth=y<1/3?'S':y<2/3?'H':'L'; var width=x<1/3?'BH':x<2/3?'M':'FH'; return {depth:depth,width:width}; }
    function drawCircle(px,py,hollow){
      if(!ctx) return;
      var r=6*DPR; ctx.beginPath(); ctx.arc(px,py,r,0,Math.PI*2); ctx.lineWidth=2*DPR;
      if(hollow){ ctx.strokeStyle='#fff'; ctx.stroke(); } else { ctx.fillStyle='#fff'; ctx.fill(); }
    }
    function drawArrow(x1,y1,x2,y2){
      if(!ctx) return;
      ctx.strokeStyle='#fff'; ctx.lineWidth=2*DPR; ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
      var ang=Math.atan2(y2-y1,x2-x1), size=8*DPR;
      ctx.beginPath(); ctx.moveTo(x2,y2);
      ctx.lineTo(x2-size*Math.cos(ang-Math.PI/6), y2-size*Math.sin(ang-Math.PI/6));
      ctx.lineTo(x2-size*Math.cos(ang+Math.PI/6), y2-size*Math.sin(ang+Math.PI/6));
      ctx.closePath(); ctx.fillStyle='#fff'; ctx.fill();
    }

    // Data model
    var rallies=[], current=null, stickySide=null, stickyStroke=null, stickySpin=null, serveSpin='Back', phase='serve1', player='A';

    function newRally(){ return {id:'R'+Date.now()+'-'+Math.floor(Math.random()*1000), shots:[], outcome:null}; }
    function addShot(s){ current.shots.push(s); updateUI(); draw(); }
    function undoShot(){ if(current.shots.length){ current.shots.pop(); current.outcome=null; updateUI(); draw(); } }
    function finishRally(type){ current.outcome=type; rallies.push(current); current=newRally(); phase='serve1'; player='A'; updateUI(); draw(); }
    function togglePlayer(){ player=(player==='A')?'B':'A'; var pp=document.getElementById('playerPill'); if(pp) pp.textContent='Player: '+player; }
    function phaseText(){ return {serve1:'Serve (bounce)', serve2:'Serve (landing)', rally:'Rally'}[phase]; }
    function hintText(){ return phase==='serve1'?'Click server bounce…': phase==='serve2'?'Click serve landing…':'Click landing for next shot…'; }
    function drawMarkers(){
      var w=canvas.width,h=canvas.height;
      for(var k=0;k<current.shots.length;k++){
        var s=current.shots[k];
        var x1=s.origin.x*w,y1=s.origin.y*h,x2=s.landing.x*w,y2=s.landing.y*h;
        drawArrow(x1,y1,x2,y2); drawCircle(x1,y1,true); drawCircle(x2,y2,false);
      }
    }
    function shorthandFor(shot){
      var side=shot.side||'?', stroke=(shot.stroke||'').slice(0,2).toUpperCase();
      var to=shot.zone_to.depth+'-'+shot.zone_to.width;
      if(shot.type==='Serve'){ return 'SV('+(shot.spin||'—')+'): '+shot.zone_from.depth+'-'+shot.zone_from.width+'→'+to; }
      return side+'-'+stroke+'→'+to;
    }

    function wireUI(){
      var cStart = document.getElementById('btnStart');
      if(cStart){ cStart.onclick = init; }
      var bUndo=document.getElementById('btnUndo'); if(bUndo) bUndo.onclick=function(){ undoShot(); if(!current.shots.length) phase='serve1'; updateUI(); };
      var bNew=document.getElementById('btnNew'); if(bNew) bNew.onclick=function(){ rallies.push(current); current=newRally(); phase='serve1'; player='A'; updateUI(); draw(); };
      var bExp=document.getElementById('btnExport'); if(bExp) bExp.onclick=exportCSV;
      var bWin=document.getElementById('btnWin'); if(bWin) bWin.onclick=function(){ finishRally('Win'); };
      var bFE=document.getElementById('btnFE'); if(bFE) bFE.onclick=function(){ finishRally('Forced'); };
      var bUE=document.getElementById('btnUE'); if(bUE) bUE.onclick=function(){ finishRally('Unforced'); };
      var sideBtns=document.getElementById('sideBtns');
      if(sideBtns){ sideBtns.addEventListener('click', function(e){ var b=e.target.closest('button[data-side]'); if(!b) return; stickySide=b.getAttribute('data-side'); updateUI(); }); }
      var clearSide=document.getElementById('clearSide'); if(clearSide){ clearSide.onclick=function(){ stickySide=null; updateUI(); }; }
      var strokeBtns=document.getElementById('strokeBtns');
      if(strokeBtns){ strokeBtns.addEventListener('click', function(e){ var b=e.target.closest('button[data-stroke]'); if(!b) return; stickyStroke=b.getAttribute('data-stroke'); updateUI(); }); }
      var spinBtns=document.getElementById('spinBtns');
      if(spinBtns){ spinBtns.addEventListener('click', function(e){ var b=e.target.closest('button[data-spin]'); if(!b) return; stickySpin=b.getAttribute('data-spin'); updateUI(); }); }
      var sspinBtns=document.getElementById('serveSpinBtns');
      if(sspinBtns){ sspinBtns.addEventListener('click', function(e){ var b=e.target.closest('button[data-sspin]'); if(!b) return; serveSpin=b.getAttribute('data-sspin'); updateUI(); }); }
    }

    function updateUI(){
      var ph=document.getElementById('phasePill'); if(ph) ph.textContent='Phase: '+phaseText();
      var st=document.getElementById('stickyPill'); if(st) st.textContent='Sticky: '+[(stickySide||'—'),(stickyStroke||'—'),(stickySpin||'—')].join(' / ');
      var row=document.getElementById('rallyRow'); if(row){ row.innerHTML=''; for(var i=0;i<current.shots.length;i++){ (function(i){ var s=current.shots[i]; var b=document.createElement('button'); b.className='shotChip'; b.textContent=(i+1)+':'+s.shorthand; b.onclick=function(){ var order=[null,'Push','Drive','Loop','Block']; var ix=order.indexOf(s.stroke); s.stroke=order[(ix+1)%order.length]; s.shorthand=shorthandFor(s); updateUI(); draw(); }; row.appendChild(b); })(i); } }
      var so=document.getElementById('serialOut'); if(so){ var t=''; for(var j=0;j<current.shots.length;j++){ t += (j? ' , ':'') + current.shots[j].shorthand; } if(current.outcome) t+=' ['+current.outcome+']'; so.textContent=t; }
      var rc=document.getElementById('rallyCount'); if(rc) rc.textContent=String(rallies.length);
    }

    function exportCSV(){
      var rows=[], header=['rally_id','shot_idx','player','type','side','stroke','spin','serve_spin','origin_x','origin_y','land_x','land_y','from_depth','from_width','to_depth','to_width','shorthand','outcome']; rows.push(header.join(','));
      for(var rIndex=0; rIndex<rallies.length+1; rIndex++){
        var r = (rIndex<rallies.length) ? rallies[rIndex] : current;
        if(!r) continue;
        for(var sIndex=0; sIndex<r.shots.length; sIndex++){
          var s = r.shots[sIndex];
          rows.push([r.id,s.idx,s.player,s.type,s.side||'',s.stroke||'',(s.spin||''),(s.type==='Serve'? serveSpin:''),
            s.origin.x.toFixed(4),s.origin.y.toFixed(4),s.landing.x.toFixed(4),s.landing.y.toFixed(4),
            s.zone_from.depth,s.zone_from.width,s.zone_to.depth,s.zone_to.width,s.shorthand,r.outcome||''].join(','));
        }
      }
      var blob=new Blob([rows.join('\\n')],{type:'text/csv'});
      var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='tt_rallies.csv'; a.click(); URL.revokeObjectURL(url);
    }

    function init(){
      if(!current){ current=newRally(); }
      phase='serve1'; player='A';
      resizeCanvas(); updateUI();
      if(canvas){
        canvas.addEventListener('click', function(evt){
          var p=toLogical(evt);
          if(phase==='serve1'){ current._serveBounce=p; phase='serve2'; updateUI(); draw(); return; }
          if(phase==='serve2'){
            var origin=current._serveBounce, land=p;
            var shot={ idx:current.shots.length, player:player, type:'Serve', side:stickySide, stroke:'Serve', spin:serveSpin,
              origin:origin, landing:land, zone_from:zoneFrom(origin.x,origin.y), zone_to:zoneFrom(land.x,land.y) };
            shot.shorthand=shorthandFor(shot); addShot(shot); phase='rally'; togglePlayer(); return;
          }
          var prev=current.shots[current.shots.length-1];
          var origin2 = prev ? prev.landing : {x:.5,y:.15};
          var land2 = p;
          var shot2={ idx:current.shots.length, player:player, type:'Stroke', side:stickySide, stroke:stickyStroke, spin:stickySpin,
            origin:origin2, landing:land2, zone_from:zoneFrom(origin2.x,origin2.y), zone_to:zoneFrom(land2.x,land2.y) };
          shot2.shorthand = shorthandFor(shot2); addShot(shot2); togglePlayer();
        });
      }
      diag("Initialized");
    }

    // Wire and auto-start
    wireUI();
    init();
    window.addEventListener('resize', resizeCanvas);
  });
})();
</script>
</body>
</html>
